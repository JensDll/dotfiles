#!/usr/bin/env bash

set -e
shopt -s extglob

declare -r reset="\033[0m"
declare -r red="\033[0;31m"
declare -r green="\033[0;32m"
declare -rl id=$(uname)

__success() {
  echo -e "${green}$*${reset}"
}

__error() {
  echo -e "${red}Error: $*${reset}" 1>&2
}

__error_and_exit() {
  echo -e "${red}Error: $*${reset}" 1>&2
  exit 1
}

__usage() {
  cat <<EOF
Usage: $(basename "${BASH_SOURCE[0]}") <version> <prefix> [options]
Arguments:
  <version>       version of the release
  <prefix>        directory in which to install
Options: [default value in bracket after description]
  --help|-h|-?    print this message and exit
  --link          symbolic link location of the executable   [$HOME/.local/bin]
EOF

  if [[ $1 == --success ]]; then
    exit 0
  else
    exit 2
  fi
}

__parse_parameters() {
  local -a arguments

  while [[ $# -gt 0 ]]; do
    local -l option="${1/#--/-}"

    link="$HOME/.local/bin"

    case "$option" in
    -\? | -help | -h)
      __usage --success
      ;;
    -link)
      shift
      link="$1"
      ;;
    -link=*)
      link="${option:6}"
      ;;
    -*)
      __error "Unknown option: $1"
      __usage
      ;;
    *)
      arguments+=("$1")
      ;;
    esac

    shift
  done

  # Argument <version>
  # Remove a single leading v
  version="${arguments[0]#v}"

  # Argument <prefix>
  # Remove all trailing /
  prefix="${arguments[1]%%+(\/)}"

  # Option --link
  # Replace a single leading ~ with $HOME
  link=${link/#\~/$HOME}

  if [[ -z $version ]]; then
    __error "Missing value for argument: <version>"
    __usage
  fi

  if [[ -z $prefix ]]; then
    __error "Missing value for argument: <prefix>"
    __usage
  fi
}

__parse_parameters "$@"
declare -r version prefix link

__cleanup() {
  echo "Removing temporary directory: $1"
  rm --recursive "$1"
}

temp_dir=$(mktemp --directory)
declare -r temp_dir

trap '__cleanup $temp_dir' EXIT

declare -r file="lua-language-server-$version-$id-x64.tar.gz"
declare -r file_uri="https://github.com/LuaLS/lua-language-server/releases/download/$version/$file"
declare -r file_output="$temp_dir/$file"

curl --location --fail --fail-early --output "$file_output" "$file_uri"

tar --recursive-unlink --extract --file "$file_output" --directory "$prefix" --one-top-level

declare -r executable="$prefix/lua-language-server-$version-$id-x64/bin/lua-language-server"

chmod 500 "$executable"

ln --symbolic --force "$executable" "$link"

ls --color=auto -l "$link/lua-language-server"
