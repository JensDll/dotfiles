#!/usr/bin/env bash

# bash -s <version> < <(curl --location --fail --silent --show-error https://raw.githubusercontent.com/JensDll/dotfiles/main/unix/.local/bin/install-ccache)

# https://ccache.dev

set -e
shopt -s shift_verbose

__echo() {
  echo "[install-ccache] $*"
}

__dispose() {
  __echo "Removing temporary directory $1"
  rm --recursive "$1"
}

__usage() {
  cat <<EOF
Usage: $(basename "${BASH_SOURCE[0]}") <version> [options]
Arguments:
  <version>       version of the release
Options: [default value in bracket after description]
  --help|-h|-?    print this message and exit
  --prefix        directory in which to install    [${HOME}/.local/bin]
EOF

  if [[ $1 == --success ]]; then
    exit 0
  else
    exit 2
  fi
}

__parse_parameters() {
  local -a arguments

  prefix="${HOME}/.local/bin"

  while [[ $# -gt 0 ]]; do
    local -l option="${1/#--/-}"

    case "${option}" in
    -\? | -help | -h)
      __usage --success
      ;;
    -prefix)
      shift
      prefix="$1"
      ;;
    -prefix=*)
      prefix="${option:8}"
      ;;
    -*)
      __echo "Unknown option: $1"
      __usage
      ;;
    *)
      arguments+=("$1")
      ;;
    esac

    shift
  done

  # Argument <version>
  # Remove a single leading v
  version=${arguments[0]#v}

  # Option --prefix
  # Replace a single leading ~ with $HOME
  prefix=${prefix/#\~/${HOME}}

  if [[ -z ${version} ]]; then
    __echo "Missing value for argument: <version>"
    __usage
  fi

  if [[ -z ${prefix} ]]; then
    __echo "Missing value for option: --prefix"
    __usage
  fi
}

__parse_parameters "$@"
declare -r version prefix

temp_dir=$(mktemp --directory)
declare -r temp_dir

trap '__dispose $temp_dir' EXIT

declare -r binary="ccache-${version}-linux-x86_64.tar.xz"
declare -r binary_uri="https://github.com/ccache/ccache/releases/download/v${version}/${binary}"
declare -r binary_output="${temp_dir}/${binary}"

declare -r signature="ccache-${version}-linux-x86_64.tar.xz.minisig"
declare -r signature_uri="https://github.com/ccache/ccache/releases/download/v${version}/${signature}"
declare -r signature_output="${temp_dir}/${signature}"

__echo "Downloading binary from ${binary_uri}"
__echo "Downloading signature from ${signature_uri}"

curl --location --fail --fail-early \
  --output "${signature_output}" "${signature_uri}" \
  --output "${binary_output}" "${binary_uri}"

__echo "Verifying binary"

minisign -Vm "${binary_output}" -P RWQX7yXbBedVfI4PNx6FLdFXu9GHUFsr28s4BVGxm4BeybtnX3P06saF

tar --extract --xz --file "${binary_output}" --directory "${temp_dir}"

declare -r executable="${binary_output%.tar.xz}/ccache"

mkdir --parents "${prefix}"
mv --target-directory="${prefix}" "${executable}"

__echo "Installed ${executable} to ${prefix}"
