#!/usr/bin/env bash

# bash -s <version> < <(curl --location --fail --silent --show-error https://raw.githubusercontent.com/JensDll/dotfiles/main/unix/.local/bin/install-ccache)

# https://ccache.dev

set -e

script_root="$(
  cd "$(dirname "${BASH_SOURCE[0]}")" > /dev/null 2>&1 || exit
  pwd -P
)"

source "$script_root/../../../scripts/common.sh"

__usage() {
  cat <<EOF
Usage: $(basename "${BASH_SOURCE[0]}") <version> [options]
Arguments:
  <version>       version of the release
Options: [default value in bracket after description]
  --help|-h|-?    print this message and exit
  --prefix        directory in which to install    [$HOME/.local/bin]
EOF

  if [[ $1 == --success ]]; then
    exit 0
  else
    exit 2
  fi
}

__parse_parameters() {
  local -a arguments

  prefix="$HOME/.local/bin"

  while [[ $# -gt 0 ]]; do
    local -l option="${1/#--/-}"

    case "$option" in
    -\? | -help | -h)
      __usage --success
      ;;
    -prefix)
      shift
      prefix="$1"
      ;;
    -prefix=*)
      prefix="${option:8}"
      ;;
    -*)
      __error "Unknown option: $1"
      __usage
      ;;
    *)
      arguments+=("$1")
      ;;
    esac

    shift
  done

  version=${arguments[0]#v}

  if [[ -z $version ]]; then
    __error "Missing value for argument: <version>"
    __usage
  fi

  if [[ -z $prefix ]]; then
    __error "Missing value for option: --prefix"
    __usage
  fi
}

__parse_parameters "$@"
declare -r version prefix

__cleanup() {
  echo "Removing temporary directory: $1"
  rm --recursive "$1"
}

temp_dir=$(mktemp --directory)
declare -r temp_dir

trap '__cleanup $temp_dir' EXIT

if [[ -n $(gpg --auto-key-locate local --locate-keys 5A939A71A46792CF57866A51996DDA075594ADB8) ]]; then
  gpg --receive-keys 5A939A71A46792CF57866A51996DDA075594ADB8
fi

declare -r binary="ccache-$version-linux-x86_64.tar.xz"
declare -r binary_uri="https://github.com/ccache/ccache/releases/download/v$version/$binary"
declare -r binary_output="$temp_dir/$binary"

declare -r signature="ccache-$version-linux-x86_64.tar.xz.asc"
declare -r signature_uri="https://github.com/ccache/ccache/releases/download/v$version/$signature"
declare -r signature_output="$temp_dir/$signature"

curl --location --fail --fail-early \
  --output "$signature_output" "$signature_uri" \
  --output "$binary_output" "$binary_uri"

if ! gpg --verify "$signature_output" "$binary_output"; then
  __error_and_exit "Signature verification failed"
fi

tar --extract --xz --file "$binary_output" --directory "$temp_dir"

declare -r executable="${binary_output%.tar.xz}/ccache"

mkdir --parents "$prefix"
mv --target-directory="$prefix" "$executable"

__success "Installed $executable to $prefix"
